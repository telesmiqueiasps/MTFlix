<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telles Flix</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <nav>
            <h1>Telles Flix</h1>
            <ul>
                <li><a href="filmes.html">Filmes</a></li>
                <li><a href="series.html">Séries</a></li>
                <li><a href="animes.html">Animes</a></li>
            </ul>
            <input type="text" id="search" placeholder="Pesquisar...">
        </nav>
    </header>

    <section>
        <h2 style="padding-left:1rem;">Últimos adicionados</h2>
        <main id="catalogo"></main>
    </section>

    <script src="assistidos.js"></script>
    <script src="script.js"></script>
    <script>
        function carregarUltimosAdicionados(urls) {
            const container = document.getElementById("catalogo");
            const searchInput = document.getElementById("search");
            let assistidos = JSON.parse(localStorage.getItem("assistidos")) || [];
            let todosItens = [];

            Promise.all(urls.map(url => fetch(url).then(r => r.json())))
                .then(respostas => {
                    respostas.forEach(lista => {
                        lista.forEach(item => {
                            if ((item.tipo === "serie" || item.tipo === "anime") && item.temporadas) {
                                let dataUltimaTemp = "2025-01-01";
                                item.temporadas.forEach(temp => {
                                    if (temp.dataAdicao && new Date(temp.dataAdicao) > new Date(dataUltimaTemp)) {
                                        dataUltimaTemp = temp.dataAdicao;
                                    }
                                });

                                todosItens.push({
                                    id: item.id,
                                    tipo: item.tipo,
                                    titulo: item.titulo,
                                    capa: item.capa,
                                    link: `${item.tipo}.html?id=${item.id}`,
                                    dataAdicao: dataUltimaTemp
                                });
                            } else {
                                todosItens.push({
                                    ...item,
                                    dataAdicao: item.dataAdicao || "2025-01-01"
                                });
                            }
                        });
                    });

                    todosItens.sort((a, b) => new Date(b.dataAdicao) - new Date(a.dataAdicao));

                    function renderCatalogo(filtro = "") {
                        container.innerHTML = "";
                        todosItens
                            .filter(item => item.titulo.toLowerCase().includes(filtro.toLowerCase()))
                            .forEach(item => {
                                const card = document.createElement("div");
                                card.classList.add("card");

                                const img = document.createElement("img");
                                img.src = item.capa;
                                img.alt = item.titulo;

                                const titulo = document.createElement("h3");
                                titulo.textContent = item.titulo;

                                if (item.tipo === "serie" || item.tipo === "anime") {
                                    const btnVer = document.createElement("button");
                                    btnVer.textContent = "Ver episódios";
                                    btnVer.addEventListener("click", () => {
                                        window.location.href = item.link;
                                    });
                                    card.appendChild(img);
                                    card.appendChild(titulo);
                                    card.appendChild(btnVer);
                                } else if (item.tipo === "filme") {
                                    const assistido = assistidos.includes(item.id);

                                    const btnAssistir = document.createElement("button");
                                    btnAssistir.textContent = assistido ? "Assistido ✅" : "Assistir";
                                    if (assistido) btnAssistir.classList.add("watched");

                                    btnAssistir.addEventListener("click", () => {
                                        window.open(item.link, "_blank");
                                        marcarAssistido("filme", item.id);
                                        renderCatalogo(filtro);
                                    });

                                    card.appendChild(img);
                                    card.appendChild(titulo);
                                    card.appendChild(btnAssistir);

                                    if (assistido) {
                                        const btnDesmarcar = document.createElement("button");
                                        btnDesmarcar.textContent = "Marcar como não assistido";
                                        btnDesmarcar.style.background = "#555";
                                        btnDesmarcar.addEventListener("click", () => {
                                            marcarNaoAssistido("filme", item.id);
                                            renderCatalogo(filtro);
                                        });
                                        card.appendChild(btnDesmarcar);
                                    }
                                }

                                container.appendChild(card);
                            });
                    }

                    searchInput?.addEventListener("input", e => {
                        renderCatalogo(e.target.value);
                    });

                    renderCatalogo();
                });
        }

        carregarUltimosAdicionados([
            "data/catalog-filmes.json",
            "data/catalog-series.json",
            "data/catalog-animes.json"
        ]);
    </script>
</body>
</html>
