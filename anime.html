<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Episódios do Anime</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .banner {
            position: relative;
            height: 250px;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: flex-end;
            padding: 1rem;
            color: white;
        }
        .banner h1 {
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 8px;
        }
        .temporada-select {
            padding: 0.5rem;
            margin: 1rem;
            background: #111;
            color: white;
            border-radius: 6px;
            border: 1px solid #444;
        }
        .episodios-container {
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .episodio-card {
            background: #222;
            border-radius: 8px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }
        .episodio-card:hover {
            transform: scale(1.02);
        }
        .episodio-thumb {
            width: 100%;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .episodio-card h3 {
            margin: 0;
            font-size: 1rem;
        }
        .episodio-card button {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            background: #e50914;
            color: white;
            cursor: pointer;
        }
        .episodio-card button.watched {
            background: #4caf50;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="animes.html" style="color:white; text-decoration:none;">⬅ Voltar</a>
        </nav>
    </header>

    <div id="banner" class="banner">
        <h1 id="animeTitulo"></h1>
    </div>

    <select id="temporadaSelect" class="temporada-select"></select>

    <main class="episodios-container" id="episodios"></main>

    <script src="assistidos.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const animeId = params.get("id");

        fetch(`data/catalog-animes.json`)
            .then(res => res.json())
            .then(animes => {
                const anime = animes.find(a => a.id === animeId);
                document.getElementById("animeTitulo").textContent = anime.titulo;
                document.getElementById("banner").style.backgroundImage = `url('${anime.capa}')`;

                const temporadaSelect = document.getElementById("temporadaSelect");
                const episodiosContainer = document.getElementById("episodios");
                let assistidos = JSON.parse(localStorage.getItem("episodiosAssistidosAnimes")) || {};

                // Preenche dropdown de temporadas
                anime.temporadas.forEach((temp, index) => {
                    const option = document.createElement("option");
                    option.value = index;
                    option.textContent = temp.titulo;
                    temporadaSelect.appendChild(option);
                });

                function renderEpisodios(temporadaIndex) {
                    episodiosContainer.innerHTML = "";
                    const temporada = anime.temporadas[temporadaIndex];

                    temporada.episodios.forEach((ep, index) => {
                        const card = document.createElement("div");
                        card.classList.add("episodio-card");

                        if (ep.thumbnail) {
                            const thumb = document.createElement("img");
                            thumb.src = ep.thumbnail;
                            thumb.alt = ep.nome;
                            thumb.classList.add("episodio-thumb");
                            card.appendChild(thumb);
                        }

                        const titulo = document.createElement("h3");
                        titulo.textContent = `E${index + 1} - ${ep.nome}`;

                        let assistidos = JSON.parse(localStorage.getItem("episodiosAssistidosAnimes")) || {};
                        const assistido = assistidos[ep.id] || false;

                        const btnAssistir = document.createElement("button");
                        btnAssistir.textContent = assistido ? "Assistido ✅" : "Assistir";
                        if (assistido) btnAssistir.classList.add("watched");

                        btnAssistir.addEventListener("click", () => {
                            window.open(ep.link, "_blank");
                            assistidos[ep.id] = true;
                            localStorage.setItem("episodiosAssistidosAnimes", JSON.stringify(assistidos));
                            renderEpisodios(temporadaIndex); // Re-renderiza para mostrar botão de "não assistido"
                        });

                        card.appendChild(titulo);
                        card.appendChild(btnAssistir);

                        if (assistido) {
                            const btnDesmarcar = document.createElement("button");
                            btnDesmarcar.textContent = "Marcar como não assistido";
                            btnDesmarcar.style.background = "#555";
                            btnDesmarcar.addEventListener("click", () => {
                                delete assistidos[ep.id];
                                localStorage.setItem("episodiosAssistidosAnimes", JSON.stringify(assistidos));
                                renderEpisodios(temporadaIndex); // Re-renderiza para atualizar botões
                            });
                            card.appendChild(btnDesmarcar);
                        }

                        episodiosContainer.appendChild(card);
                    });
                }



                // Evento de mudança de temporada
                temporadaSelect.addEventListener("change", (e) => {
                    renderEpisodios(e.target.value);
                });

                // Renderiza a primeira temporada por padrão
                renderEpisodios(0);
            });
    </script>
</body>
</html>
